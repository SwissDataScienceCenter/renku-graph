---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fuseki-server-sh
  labels:
    app: {{ template "jena.name" . }}
    chart: {{ template "jena.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
type: Opaque
data:
  fuseki-server.sh: |-
    #!/bin/sh

    # killing Jena if already started as Lucene indexing cannot happen on started Jena
    killall -9 java

    JAVA=$JAVA_HOME/bin/java
    JAR=$FUSEKI_HOME/fuseki-server.jar

    echo Rebuilding Lucene indices...
    DATASET_CONFIG=$FUSEKI_BASE/configuration/{{ .Values.global.graph.jena.dataset }}.ttl
    $JAVA -Xmx2G -cp $JAR jena.textindexer --desc=$DATASET_CONFIG

    echo Starting Fuseki...
    JVM_ARGS=${JVM_ARGS:--Xmx2G}
    $JAVA $JVM_ARGS -jar $JAR "$@"
